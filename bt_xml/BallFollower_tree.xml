<!-- Behaviour Tree that sequentially navigates locations naively -->
<root main_tree_to_execute = "MainTree">
    <BehaviorTree ID="MainTree">
        <!-- <SequenceStar> -->
            <!-- <LineFollower name = "line_follow" Ip_action_type="0"/> -->
            <Repeat num_cycles="10">
            
                <SequenceStar>
                    <SubTree ID = "FindBall_AND_StoreInSilo"/>
                    <GoToOrigin name= "ToOrigin"/>
                    <waitActionClient  In_sec="1" In_nanosec="0"/>
                </SequenceStar>
            </Repeat>
        <!-- </SequenceStar> -->
     <!-- <Sequence>
            <PneumaticOn name="Lower_pneumatic" Op_PneumaticStatus="{PneumaticStatus}"/>
            <TurnOnRoller name = "Start_intake_roller" 
                    Op_RollerStatus="{RollerStatus}"
                    Op_RollerSpeed="{RollerSpeed}"
                    Ip_RollerSpeed="60"/>
            <TurnOnConveyer name = "Keep_conveyer_running" 
                    Op_ConveyerStatus="{ConveyerStatus}"
                    Op_ConveyerSpeed="{ConveyerSpeed}" 
                    Ip_ConveyerSpeed="10"/>
            <PacketPublisher name="packetPublisher"
                    Ip_RollerStatus="{RollerStatus}"
                    Ip_RollerSpeed="{RollerSpeed}"
                    Ip_ConveyerStatus="{ConveyerStatus}"
                    Ip_ConveyerSpeed="{ConveyerSpeed}"
                    Ip_PneumaticStatus="{PneumaticStatus}"/>
        </Sequence> -->

    </BehaviorTree>

    <BehaviorTree ID="FindBall_AND_StoreInSilo">
        <Inverter>
            <KeepRunningUntilFailure>
                <Inverter>
                    <SequenceStar>
                        <InitiallizeActuators name = "initiallize_actutatos"
                            Op_RollerStatus="{RollerStatus}"
                            Op_RollerSpeed="{RollerSpeed}"
                            Op_ConveyerStatus="{ConveyerStatus}"
                            Op_ConveyerSpeed="{ConveyerSpeed}"
                            Op_PneumaticStatus="{PneumaticStatus}"/>
                        <PacketPublisher name="packetPublisher"
                            Ip_RollerStatus="{RollerStatus}"
                            Ip_RollerSpeed="{RollerSpeed}"
                            Ip_ConveyerStatus="{ConveyerStatus}"
                            Ip_ConveyerSpeed="{ConveyerSpeed}"
                            Ip_PneumaticStatus="{PneumaticStatus}"/>
                        <Inverter>
                            <KeepRunningUntilFailure>
                                <WhileDoElse> 
                                        <Inverter>
                                            <isBallDetected name="isBallDetected_node" op_ballDetectionFlag="{ballDetectionFlag}"/>
                                        </Inverter>
                                        <Sequence >
                                            <!-- <spinActionClient  In_angle="1.57"/> -->
                                            <waitActionClient  In_sec="1" In_nanosec="1"/>
                                            <!-- <spinActionClient  In_angle="-3.124"/> -->
                                            <waitActionClient  In_sec="1" In_nanosec="1"/>
                                            <!-- <spinActionClient  In_angle="1.57"/> -->
                                            <waitActionClient  In_sec="1" In_nanosec="1"/>

                                        </Sequence>
                                        <returnFailure/>
                                </WhileDoElse>  
                            </KeepRunningUntilFailure>
                        </Inverter>

                        <GetBallPose name="GetBallPose_node" op_pose="{pose}"/>
                        <GoToBallPose name="GoToBallPose_node" in_pose="{pose}"/>

                        <SubTree ID="Start_mechanisms"
                            RollerStatus="{RollerStatus}"
                            RollerSpeed="{RollerSpeed}"
                            ConveyerStatus="{ConveyerStatus}"
                            ConveyerSpeed="{ConveyerSpeed}"
                            PneumaticStatus="{PneumaticStatus}"/>
                        <SubTree ID="Retrieve_balls" 
                            RollerStatus="{RollerStatus}"
                            RollerSpeed="{RollerSpeed}"
                            ConveyerStatus="{ConveyerStatus}"
                            ConveyerSpeed="{ConveyerSpeed}"
                            PneumaticStatus="{PneumaticStatus}"/> 
                        <SubTree ID="Go_TO_SILO"/>
                        <waitActionClient  In_sec="1" In_nanosec="0"/>
                        <TurnOnConveyer name = "Keep_conveyer_running_1" 
                            Op_ConveyerStatus="{ConveyerStatus}"
                            Op_ConveyerSpeed="{ConveyerSpeed}" 
                            Ip_ConveyerSpeed="80"/>
                        <PacketPublisher name="packetPublisher"
                            Ip_RollerStatus="{RollerStatus}"
                            Ip_RollerSpeed="{RollerSpeed}"
                            Ip_ConveyerStatus="{ConveyerStatus}"
                            Ip_ConveyerSpeed="{ConveyerSpeed}"
                            Ip_PneumaticStatus="{PneumaticStatus}"/>
                        <waitActionClient  In_sec="5" In_nanosec="0"/>
                        <TurnOffConveyer name = "Stop_conveyer" Op_ConveyerStatus="{ConveyerStatus}"/>
                        <PacketPublisher name="packetPublisher"
                            Ip_RollerStatus="{RollerStatus}"
                            Ip_RollerSpeed="{RollerSpeed}"
                            Ip_ConveyerStatus="{ConveyerStatus}"
                            Ip_ConveyerSpeed="{ConveyerSpeed}"
                            Ip_PneumaticStatus="{PneumaticStatus}"/>
                        <waitActionClient  In_sec="1" In_nanosec="0"/>
                    </SequenceStar>
                </Inverter>
            </KeepRunningUntilFailure>
        </Inverter>
    </BehaviorTree>

    <BehaviorTree ID="Ball_Intake">
        <Sequence >
            <SubTree ID="Start_mechanisms"/>
            <SubTree ID="Retrieve_balls"/>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="Start_mechanisms">
        <Sequence>
            <PneumaticOn name="Lower_pneumatic" Op_PneumaticStatus="{PneumaticStatus}"/>
            <TurnOnRoller name = "Start_intake_roller" 
                    Op_RollerStatus="{RollerStatus}"
                    Op_RollerSpeed="{RollerSpeed}"
                    Ip_RollerSpeed="60"/>
            <TurnOnConveyer name = "Keep_conveyer_running" 
                    Op_ConveyerStatus="{ConveyerStatus}"
                    Op_ConveyerSpeed="{ConveyerSpeed}" 
                    Ip_ConveyerSpeed="80"/>
            <PacketPublisher name="packetPublisher"
                    Ip_RollerStatus="{RollerStatus}"
                    Ip_RollerSpeed="{RollerSpeed}"
                    Ip_ConveyerStatus="{ConveyerStatus}"
                    Ip_ConveyerSpeed="{ConveyerSpeed}"
                    Ip_PneumaticStatus="{PneumaticStatus}"/>
        </Sequence>
    </BehaviorTree>

    <BehaviorTree ID="Go_TO_SILO">
        <SequenceStar>
            <GoToSiloPose name="goToSilo" Op_SiloNumber="{SiloNumber}"/>
            <LineFollower name = "line_follow" Ip_action_type="1"/>
            <ResetOdom name = "Reset" Ip_SiloNumber="{SiloNumber}"/>
        </SequenceStar>
    </BehaviorTree>


    <BehaviorTree ID="Retrieve_balls">
        <SequenceStar name ="IntakeBalls">
            <!-- Ball picking tree -->
            <Inverter>
                <KeepRunningUntilFailure>
                    <Inverter>
                        <IfThenElse>                            
                            <isBallInside name = "isBallInside"/>
                            <SequenceStar>
                                <TurnOffRoller name = "Stop_roller" Op_RollerStatus="{RollerStatus}"/> 
                                <PneumaticOff name="Lower_pneumatic" Op_PneumaticStatus="{PneumaticStatus}"/>
                                <PacketPublisher name="packetPublisher"
                                    Ip_RollerStatus="{RollerStatus}"
                                    Ip_RollerSpeed="{RollerSpeed}"
                                    Ip_ConveyerStatus="{ConveyerStatus}"
                                    Ip_ConveyerSpeed="{ConveyerSpeed}"
                                    Ip_PneumaticStatus="{PneumaticStatus}"/>
                            </SequenceStar>
                            <returnFailure name="returnFailed"/>
                        </IfThenElse>
                    </Inverter>
                </KeepRunningUntilFailure>
            </Inverter>
            <!-- test tree -->
            <!-- <waitActionClient  In_sec="1" In_nanosec="0"/>
            <TurnOffConveyer name = "Stop_conveyer" Op_ConveyerStatus="{ConveyerStatus}"/>
            <PacketPublisher name="packetPublisher"
                    Ip_RollerStatus="{RollerStatus}"
                    Ip_RollerSpeed="{RollerSpeed}"
                    Ip_ConveyerStatus="{ConveyerStatus}"
                    Ip_ConveyerSpeed="{ConveyerSpeed}"
                    Ip_PneumaticStatus="{PneumaticStatus}"/>
            -->
            
            <!-- Ball sorting tree -->
            <Inverter>
                <KeepRunningUntilFailure>
                    <Inverter>
                        <IfThenElse>
                            <isOnlyBall name="isOnlyBall"/>
                            <SequenceStar>
                                <TurnOffConveyer name = "Stop_conveyer" Op_ConveyerStatus="{ConveyerStatus}"/>
                                <PacketPublisher name="packetPublisher"
                                        Ip_RollerStatus="{RollerStatus}"
                                        Ip_RollerSpeed="{RollerSpeed}"
                                        Ip_ConveyerStatus="{ConveyerStatus}"
                                        Ip_ConveyerSpeed="{ConveyerSpeed}"
                                        Ip_PneumaticStatus="{PneumaticStatus}"/>
                            </SequenceStar>        
                        </IfThenElse>
                    </Inverter>
                </KeepRunningUntilFailure>
            </Inverter>
        </SequenceStar>
    </BehaviorTree> 

</root>


